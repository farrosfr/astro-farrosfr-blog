<div id="search-modal-container" class="hidden">
    <div id="search-modal-backdrop"></div>
    <div id="search-modal-panel">
        <div id="search-modal-header">
            <input type="text" id="search-modal-input" placeholder="Search for anything..." />
            <button id="search-modal-close" aria-label="Close search modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div id="search-modal-results"></div>
    </div>
</div>

<style>
    #search-modal-container {
        position: fixed;
        inset: 0;
        z-index: 50;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 10vh;
    }

    #search-modal-container.hidden {
        display: none;
    }

    #search-modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    #search-modal-panel {
        position: relative;
        width: 100%;
        max-width: 600px;
        background-color: var(--header-bg-color);
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        overflow: hidden;
    }

    #search-modal-header {
        display: flex;
        align-items: center;
        border-bottom: 1px solid rgb(var(--gray-light));
    }

    #search-modal-input {
        width: 100%;
        padding: 1rem;
        border: none;
        background: transparent;
        color: var(--header-text-color);
        font-size: 1.1rem;
    }
    #search-modal-input:focus {
        outline: none;
    }

    #search-modal-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 1rem;
        color: var(--header-text-color);
    }

    #search-modal-results {
        padding: 1rem;
        max-height: 70vh;
        overflow-y: auto;
    }

    .result-item {
        padding: 0.75rem 1rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s ease;
    }

    .result-item:hover {
        background-color: rgba(var(--gray), 0.1);
    }

    .result-item a {
        text-decoration: none;
        color: var(--header-text-color);
    }

    .result-item h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1.1em;
    }

    .result-item p {
        margin: 0;
        font-size: 0.9em;
        color: rgb(var(--gray));
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const openTrigger = document.getElementById('search-trigger');
        const modalContainer = document.getElementById('search-modal-container');
        const closeTrigger = document.getElementById('search-modal-close');
        const backdrop = document.getElementById('search-modal-backdrop');
        const searchInput = document.getElementById('search-modal-input');
        const resultsContainer = document.getElementById('search-modal-results');

        if (!openTrigger || !modalContainer || !closeTrigger || !backdrop || !searchInput || !resultsContainer) {
            return;
        }

        let pagefind;

        const showModal = async () => {
            modalContainer.classList.remove('hidden');
            searchInput.focus();
            if (!pagefind) {
                pagefind = await import('/pagefind/pagefind.js');
            }
        };

        const hideModal = () => {
            modalContainer.classList.add('hidden');
        };

        openTrigger.addEventListener('click', showModal);
        closeTrigger.addEventListener('click', hideModal);
        backdrop.addEventListener('click', hideModal);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') hideModal();
            if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
                e.preventDefault();
                showModal();
            }
        });

        searchInput.addEventListener('input', async (e) => {
            const query = (e.target as HTMLInputElement).value;
            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }

            const search = await pagefind.search(query);
            resultsContainer.innerHTML = '';

            if (search.results.length === 0) {
                resultsContainer.innerHTML = '<p>No results found.</p>';
                return;
            }

            for (const result of search.results) {
                const data = await result.data();
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <a href="${data.url}">
                        <h4>${data.meta.title}</h4>
                        <p>${data.excerpt}</p>
                    </a>
                `;
                item.addEventListener('click', hideModal);
                resultsContainer.appendChild(item);
            }
        });
    });
</script>
